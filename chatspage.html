<!DOCTYPE html>

<html lang="en">

    <head>
        <title>HotTake - Chats</title>
        <link href="styles.css" rel="stylesheet" type="text/css" media="all">
        <link href="app.css" rel="stylesheet" type="text/css" media="all">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://use.typekit.net/nwy3jid.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/favicon-16x16.png">
        <link rel="manifest" href="assets/favicon/site.webmanifest">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    </head>

    <body>
        
        <div class="page-body" style="width: 100% !important;">
            <div class="chat-score-display" style="height: 160px;">
                <div class="scorecard">
                    <div class="game-date-time-container no-border">
                        <p class="game-date-time"></p>
                    </div>
                    <div class="scorecard-game-info" style="border-radius: 0 !important;">
                        <p style="margin: 0;"><span class="game-time"></span><span class="quarter"></span></p>
                    </div>
                    <div class="scorecard-teams-container">
                        <div class="scorecard-team-card left-team chat-team-card ctc-l">
                            <p class="scorecard-score" id="score-home-team">-</p>
                            <p class="home-team"><span class="scorecard-team" id="name-home-team"></span><span class="scorecard-team-record"></span></p>
                        </div>
                        <div class="scorecard-team-card right-team chat-team-card ctc-r">
                            <p class="away-team"><span class="scorecard-team" id="name-away-team"></span><span class="scorecard-team-record"></span></p>
                            <p class="scorecard-score" id="score-away-team">-</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="nav-bar" style="margin-top: 0; background-color: black;">
                <a class="back-btn" href="home.html" style="margin-left: 24px;"><img  src="assets/icons/left-arrow.png" alt="Left Arrow"></a>
                <p class="nav-label">Chat</p>
            </div>

            <div class="tab-page">
                <!-- minified snippet to load TalkJS without delaying your page -->
                <script>
                    (function(t,a,l,k,j,s){
                    s=a.createElement('script');s.async=1;s.src="https://cdn.talkjs.com/talk.js";a.head.appendChild(s)
                    ;k=t.Promise;t.Talk={v:3,ready:{then:function(f){if(k)return new k(function(r,e){l.push([f,r,e])});l
                    .push([f])},catch:function(){return k&&new k()},c:l}};})(window,document,[]);
                </script>
                <!-- container element in which TalkJS will display a chat UI -->
                <div id="talkjs-container" style="width: 100%; margin: auto; height: 90vh;">
                    <i>Loading chat...</i>
                </div>
            </div>

        </div>

        <!-- The core Firebase JS SDK is always required and must be listed first -->
        <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
        <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
        <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-analytics.js"></script>
        <!-- Add Firebase products that you want to use -->
        <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-firestore.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-database.js"></script>
        <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyC5Hg9BK3TYLPEkEgicBjYnS0zqrJxEUdE",
            authDomain: "hottake-af593.firebaseapp.com",
            databaseURL: "https://hottake-af593.firebaseio.com",
            projectId: "hottake-af593",
            storageBucket: "hottake-af593.appspot.com",
            messagingSenderId: "1022543631385",
            appId: "1:1022543631385:web:90f7d0ae19d193c8ae4688"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);        
        </script>        
    </body>
</html>
<script>
    // Set db
    var db = firebase.firestore();
    var chatTeam = "";
    if(window.location.search.length > 0) {
        chatTeam = window.location.search.substring(6).replace("_", " ").replace("%20", " ");
    }

    var playerTeamAbbreviation = "";
    var teams = ["Minnesota Vikings", "New York Giants", "New England Patriots", "New York Jets"
                , "Arizona Cardinals", "Atlanta Falcons", "Baltimore Ravens", "Buffalo Bills",
                "Carolina Panthers", "Chicago Bears", "Cincinnati Bengals", "Cleveland Browns",
                "Dallas Cowboys", "Denver Broncos", "Detroit Lions", "Green Bay Packers",
                "Houston Texans", "Indianapolis Colts", "Jacksonville Jaguars", "Kansas City Chiefs",
                "Las Vegas Raiders", "Los Angeles Chargers", "Los Angeles Rams", "Miami Dolphins",
                "New Orleans Saints", "Philadelphia Eagles", "Pittsburgh Steelers", "San Francisco 49ers",
                "Seattle Seahawks", "Tampa Bay Buccaneers", "Tennessee Titans", "Washington"];
    var teamsAbbreviated = ["MIN", "NYG", "NE", "NYJ", "ARI", "ATL", "BAL", "BUF", "CAR", "CHI", "CIN", "CLE", 
                            "DAL", "DEN", "DET", "GB", "HOU", "IND", "JAX", "KC", "LV", "LAC", "LA", "MIA", "NO",
                            "PHI", "PIT", "SF", "SEA", "TB", "TEN", "WAS"];

    // Firebase observer
    firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
        var email = user.email;
        db.collection("users").doc(email).get().then(function(doc) {
            if (doc.exists) {
                var userTeam = doc.data().team;
                console.log(userTeam);
                if (chatTeam == "") {
                    chatTeam = userTeam;
                }
                console.log(chatTeam);
                // document.getElementsByClassName("team-name")[0].innerHTML = doc.data().team;
                // document.getElementsByClassName("team-image")[0].src = "assets/team_images/" + doc.data().team + ".png";
                Talk.ready.then(function() {
                    var me = new Talk.User({
                        id: user.email,
                        name: user.displayName,
                        email: user.email,
                        photoUrl: user.photoURL, 
                        role: "fan_1"
                    });
                    window.talkSession = new Talk.Session({
                        appId: "tJDiNf9l",
                        me: me
                    });
                    var other = new Talk.User({
                        id: "other",
                        name: " ",
                        email: "other@example.com",
                        // photoUrl: "https://demo.talkjs.com/img/sebastian.jpg",
                        role: "fan_2"
                    });
                    var other2 = new Talk.User({
                        id: "other2",
                        name: " ",
                        email: "other2@example.com",
                        // photoUrl: "https://demo.talkjs.com/img/sebastian.jpg",
                        role: "fan_2",
                    });
                    // While loop through all possible rooms for chatTeam
                    // If more than 5 people in room, keep iterating through while loop until finding proper room
                    var i = 0;
                    var breakingOut = false;
                    async function theWhileLoop() {
                        setTimeout(async function() {
                            i++;
                            var conversationID = chatTeam.replaceAll(" ", "%20") + parseInt(i);
                            console.log(conversationID);
                            console.log(breakingOut);
                            // Make PUT call to create rooms if they don't already exist
                            const result = await $.ajax({
                                type: "PUT",
                                url: "https://api.talkjs.com/v1/tJDiNf9l/conversations/" + conversationID,
                                beforeSend: function(xhr) {
                                    xhr.setRequestHeader("Authorization", "Bearer sk_test_N6LHWpCwqqnF5rHmOsQbxHph")
                                }, 
                                data: {
                                },
                                contentType:"application/json; charset=utf-8",
                                dataType:"json",
                                success: function(data){
                                    console.log(data);
                                },
                                error: function(xhr, status, error) {
                                    console.log("ERROR");
                                    alert(xhr.responseText);
                                }
                            });
                            // Make GET call to get current number of users
                            $.ajax({
                                type: "GET",
                                url: "https://api.talkjs.com/v1/tJDiNf9l/conversations/" + conversationID,
                                beforeSend: function(xhr) {
                                    xhr.setRequestHeader("Authorization", "Bearer sk_test_N6LHWpCwqqnF5rHmOsQbxHph")
                                }, 
                                cache: true,
                                success: function(data){
                                    console.log(data);
                                    console.log(data.participants);
                                    var participants = data.participants;
                                    console.log(participants);
                                    var participantsLength = 0;
                                    for (var participant in participants) {
                                        participantsLength++;
                                    }
                                    console.log(participantsLength);
                                    if (participantsLength < 5) {
                                        console.log("Less than 5 users, break while loop");
                                        breakingOut = true;
                                    }
                                }
                            });
                            if (i > 10 || breakingOut) {
                                console.log("Breaking while loop");
                                theWhileLoop();
                            }
                        }, 500)
                    }
                    theWhileLoop();
                    var currentConversationID = chatTeam + parseInt(i);
                    var conversation = talkSession.getOrCreateConversation(currentConversationID);
                    conversation.setAttributes({
                        subject: currentConversationID,
                        // custom: { "numUsers": parseInt(newNumUsers) }
                    });
                    // conversation.setAttributes({custom:
                    // {
                    //     numUsers: "test"
                    // }
                    // });
                    conversation.setParticipant(me);
                    conversation.setParticipant(other);
                    conversation.setParticipant(other2);
                    console.log(conversation);
                    var inbox = talkSession.createInbox({selected: conversation});
                    inbox.mount(document.getElementById("talkjs-container"));
                });
                for (var i = 0; i < teams.length; i++) {
                    if (teams[i] == chatTeam) {
                        playerTeamAbbreviation = teamsAbbreviated[i];
                        getScore();
                    }
                }
                if (chatTeam != "") {
                    for (var i = 0; i < teams.length; i++) {
                        if (teams[i] == chatTeam) {
                            playerTeamAbbreviation = teamsAbbreviated[i];
                            getScore();
                        }
                    }
                }
            }
        }).catch(function(error) {
            console.error("Error getting user info: ", error);
        });

        // Get and display score of most recent game for current team
        getScore();
    } 
    });

    function getScore() {
        $.ajax({
            type: "GET",
            url: "https://static.nfl.com/liveupdate/scorestrip/ss.xml",
            success: function(results) {
                console.log("Success");
                displayScore(results)
            },
            error: function(error) {
                console.log(error);
            }
        });
    }
    function displayScore(results) {
        resultsList = results.getElementsByTagName("g");
        for (var i = 0; i < resultsList.length; i++) {
            result = resultsList[i];
            if (result.getAttribute("h") == playerTeamAbbreviation || result.getAttribute("v") == playerTeamAbbreviation) {
                document.getElementById("score-home-team").innerHTML = result.getAttribute("hs");
                document.getElementById("score-away-team").innerHTML = result.getAttribute("vs");
                document.getElementById("name-home-team").innerHTML = result.getAttribute("h")
                document.getElementById("name-away-team").innerHTML = result.getAttribute("v")
                if (result.getAttribute("q") == "1" || result.getAttribute("q") == "2" ||
                    result.getAttribute("q") == "3" || result.getAttribute("q") == "4") {
                        document.getElementsByClassName("game-time")[0].innerHTML = result.getAttribute("k");
                    } 
                document.getElementsByClassName("quarter")[0].innerHTML = result.getAttribute("q");
                document.getElementsByClassName("game-date-time")[0].innerHTML = 
                result.getAttribute("hnn").charAt(0).toUpperCase() + result.getAttribute("hnn").slice(1) + " at "
                + result.getAttribute("vnn").charAt(0).toUpperCase() + result.getAttribute("vnn").slice(1)
                + " - " + result.getAttribute("d") + ", " + result.getAttribute("t");
            }
        }
    }
</script>