<!DOCTYPE html>

<html lang="en">

    <head>
        <title>HotTake - What's Hot</title>
        <link href="styles.css" rel="stylesheet" type="text/css" media="all">
        <link href="app.css" rel="stylesheet" type="text/css" media="all">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://use.typekit.net/nwy3jid.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/favicon-16x16.png">
        <link rel="manifest" href="assets/favicon/site.webmanifest">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <!-- Test Account to use: jeffsu@gmail.com, test123, Chiefs Fan -->
        <!-- Also: bobby42@aol.com, test123, Rams Fan -->
    </head>

    <body>
        <div class="page-body">
            <p class="page-title-large">What's Hot</p>
            <div class="tab-page" style="display: none;">
                <p class="subtitle" style="margin-bottom: 0;">Scores</p>
                <p class="sub-line">View the latest scores of your favorite teams, tap on the game score to read more and join the game chat.</p>
                <div class="scorecard">
                    <div class="game-date-time-container">
                        <p class="game-date-time"></p>
                    </div>
                    <div class="scorecard-game-info">
                        <p style="margin: 0;"><span class="game-time"></span><span class="quarter"></span></p>
                    </div>
                    <a href="gamepage.html" style="text-decoration: inherit;">
                        <div class="scorecard-teams-container">
                            <div class="scorecard-team-card left-team">
                                <p style="margin: 4px;"><span class="scorecard-team" id="name-player-team"></span><span class="scorecard-team-record"></span></p>
                                <p class="scorecard-score" id="score-player-team">-</p>
                            </div>
                            <div class="scorecard-team-card right-team">
                                <p style="margin: 4px;"><span class="scorecard-team" id="name-other-team"></span><span class="scorecard-team-record"></span></p>
                                <p class="scorecard-score" id="score-other-team">-</p>
                            </div>
                        </div>
                    </a>
                </div>
                <p class="subtitle">Your Chats</p>
                <div class="chat-list-item" onclick="location.href='chatspage.html';">
                    <img class="team-image" src="" alt="Team Image">
                    <div>
                        <p class="team-name">Team Name</p>
                        <p class="members">Fan Hub</p>
                    </div>
                </div>
                <p class="subtitle" style="margin-bottom: 0;">The Latest</p>
                <p class="sub-line" style="margin-bottom: 20px;">Read the latest from around the league on your team</p>
                <div class="storyline-list">
                </div>
            </div>
            <div class="loader"></div>
        </div>

        <!-- Div for tab bar -->
        <div class="tab-bar">
            <div class="tab-bar-item active">
                <img class="tab-bar-img" src="assets/icons/fire_icon.svg" alt="Fire Icon">
            </div>
            <div class="tab-bar-item" onclick="location.href='chat.html';">
                <img class="tab-bar-img" src="assets/icons/chat_icon.svg" alt="Chat Icon">
            </div>
            <div class="tab-bar-item" onclick="location.href='userpage.html';">
                <img class="tab-bar-img" src="assets/icons/user_icon.svg" alt="User Icon">
            </div>
        </div>

        <!-- Include outside scripts -->
        <script src="interactions.js"></script>
        <script src="includedContent.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-analytics.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-firestore.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-database.js"></script>
        <script>
            // Your web app's Firebase configuration
            var firebaseConfig = {
                apiKey: "AIzaSyC5Hg9BK3TYLPEkEgicBjYnS0zqrJxEUdE",
                authDomain: "hottake-af593.firebaseapp.com",
                databaseURL: "https://hottake-af593.firebaseio.com",
                projectId: "hottake-af593",
                storageBucket: "hottake-af593.appspot.com",
                messagingSenderId: "1022543631385",
                appId: "1:1022543631385:web:90f7d0ae19d193c8ae4688"
            };
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);        
        </script>        
    </body>
</html>

<script>
    // Set db
    var db = firebase.firestore();
    var latestQuery = "";
    var playerTeamAbbreviation = "";

    // Firebase observer
    firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
        var email = user.email;
        console.log(email);
        db.collection("users").doc(email).get().then(function(doc) {
            if (doc.exists) {
                console.log(doc.data().team);
                latestQuery = doc.data().team;
                document.getElementsByClassName("team-name")[0].innerHTML = doc.data().team;
                document.getElementsByClassName("team-image")[0].src = "assets/team_images/" + doc.data().team + ".png";
                for (var i = 0; i < teams.length; i++) {
                    if (teams[i] == doc.data().team) {
                        playerTeamAbbreviation = teamsAbbreviated[i];
                        getScore();
                    }
                }
            }
        }).catch(function(error) {
            console.error("Error getting user info: ", error);
        });
    } 
    });

    // Display live game information from NFL
    // Display recent tweets about the game from TweetJS
    function displayScore(results) {
        resultsList = results.getElementsByTagName("g");
        for (var i = 0; i < resultsList.length; i++) {
            result = resultsList[i];
            if (result.getAttribute("h") == playerTeamAbbreviation || result.getAttribute("v") == playerTeamAbbreviation) {
                console.log(result.getAttribute("hs"));
                console.log(result.getAttribute("vs"));
                document.getElementById("score-player-team").innerHTML = result.getAttribute("vs");
                document.getElementById("score-other-team").innerHTML = result.getAttribute("hs");
                document.getElementById("name-player-team").innerHTML = result.getAttribute("v");
                document.getElementById("name-other-team").innerHTML = result.getAttribute("h");
                // Set colors for home team
                document.getElementsByClassName("left-team")[0].style.backgroundColor = teamColors[result.getAttribute("v")][0];
                document.getElementById("score-player-team").style.color = teamColors[result.getAttribute("v")][1];
                document.getElementById("name-player-team").style.color = teamColors[result.getAttribute("v")][1];
                // Set colors for away team
                document.getElementsByClassName("right-team")[0].style.backgroundColor = teamColors[result.getAttribute("h")][0];
                document.getElementById("score-other-team").style.color = teamColors[result.getAttribute("h")][1];
                document.getElementById("name-other-team").style.color = teamColors[result.getAttribute("h")][1];
                document.getElementsByClassName("quarter")[0].innerHTML = result.getAttribute("q");
                document.getElementsByClassName("game-date-time")[0].innerHTML = 
                result.getAttribute("hnn").charAt(0).toUpperCase() + result.getAttribute("hnn").slice(1) + " at "
                + result.getAttribute("vnn").charAt(0).toUpperCase() + result.getAttribute("vnn").slice(1)
                + " - " + result.getAttribute("d") + ", " + result.getAttribute("t");
            }
            if (result.getAttribute("q") == "1" || result.getAttribute("q") == "2" ||
                result.getAttribute("q") == "3" || result.getAttribute("q") == "4") {
                document.getElementsByClassName("game-time")[0].innerHTML = result.getAttribute("k");
            }
        }

        console.log(latestQuery);

        TweetJs = {
            ListTweetsOnUserTimeline : function(screenName, callback) {
                TweetJs._callApi({
                        Action: "ListTweetsOnUserTimeline",
                        ScreenName: screenName
                    },
                callback);
            },
            Search: function (query, callback) {
                TweetJs._callApi({
                    Action: "Search",
                    Query: query
                }, callback);
            },
            _callApi: function (request, callback) {
                var xhr = new XMLHttpRequest();
                URL = "https://www.tweetjs.com/API.aspx"; 
                xhr.open("POST", URL);
                xhr.onreadystatechange = function () {
                    if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                        callback(JSON.parse(xhr.response));
                    }
                }
                xhr.send(JSON.stringify(request));
            }
        };

        TweetJs.Search(latestQuery,
        function (data) {
            console.log(data);
            for (let i=0; i<5;i++) {
                createStoryItem(data.statuses[i]);
            }
        });

        function createStoryItem(data) {
            var tweetSubstring = data.text.substr(0, data.text.indexOf('https://tweetjs'));
            console.log(tweetSubstring);

            var story_item = document.createElement("div");
            story_item.setAttribute("class", "storyline-item");
            story_item.setAttribute("id", data.id);
            var topline = document.createElement("div");
            topline.setAttribute("class", "topline");
            var topline_label = document.createElement("span");
            topline_label.innerText = playerTeamAbbreviation;
            topline.append(topline_label);
            var topline_author = document.createElement("span");
            topline_author.setAttribute("class", "topline-author");
            topline_author.setAttribute("style", "margin-left: auto; font-weight: 400;");
            topline_author.innerText = "@" + data.user.screen_name;
            topline.append(topline_author);
            story_item.append(topline);
            var story_text = document.createElement("span");
            story_text.innerText = tweetSubstring;
            // console.log(data.text);
            story_item.append(story_text);
            document.getElementsByClassName("storyline-list")[0].append(story_item);
        }
    }
</script>